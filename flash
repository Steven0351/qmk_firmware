#!/usr/bin/env bash

if [ "$#" -ne 1 ]; then
    echo "Usage: $0 <FirmwareToCopy>"
    echo "Example: $0 firmware.uf2"
    exit 1
fi

FILE_TO_COPY="$1"
VOLUME_NAME="RPI-RP2"
VOLUME_MOUNT_PATH="/Volumes/$VOLUME_NAME"

if [ ! -f "$FILE_TO_COPY" ]; then
    echo "Error: Source file '$FILE_TO_COPY' not found."
    exit 1
fi

echo "Waiting for volume '$VOLUME_NAME' to become available at '$VOLUME_MOUNT_PATH'..."

while true; do
    if [ -d "$VOLUME_MOUNT_PATH" ]; then
        echo
        echo "Volume '$VOLUME_NAME' is now available."
        break
    fi
    # Wait for a second before checking again
    sleep 1
    echo -n "." # Print a dot for visual feedback without a newline
done

echo "Attempting to copy '$FILE_TO_COPY' to the root of '$VOLUME_NAME' ($VOLUME_MOUNT_PATH/)..."
sleep 1 # Wait a second to make sure the device is ready. The mount point appearing does not mean that it is ready to be written to.

DESTINATION_PATH="$VOLUME_MOUNT_PATH/"

if cp "$FILE_TO_COPY" "$DESTINATION_PATH"; then
    echo "File successfully copied to '$DESTINATION_PATH'."
else
    echo "Error: Failed to copy '$FILE_TO_COPY' to '$DESTINATION_PATH'."
    echo "Please check permissions or available space on the volume."
    exit 1
fi
